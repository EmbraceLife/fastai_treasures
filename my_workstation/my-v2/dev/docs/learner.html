---

title: Learner
keywords: fastai
sidebar: home_sidebar

summary: "Basic class for handling the training loop"
---
<!--


#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: dev/12_learner.ipynb
# instructions: https://docs.fast.ai/gen_doc_main.html

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Synthetic-data">Synthetic data<a class="anchor-link" href="#Synthetic-data">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="k">import</span> <span class="n">TensorDataset</span>

<span class="k">def</span> <span class="nf">synth_data</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">n_trn</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_val</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">x_trn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">bs</span><span class="o">*</span><span class="n">n_trn</span><span class="p">)</span>
    <span class="n">y_trn</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">x_trn</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">bs</span><span class="o">*</span><span class="n">n_trn</span><span class="p">)</span>
    <span class="n">x_val</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">bs</span><span class="o">*</span><span class="n">n_val</span><span class="p">)</span>
    <span class="n">y_val</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">x_val</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">bs</span><span class="o">*</span><span class="n">n_val</span><span class="p">)</span>
    <span class="n">train_ds</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">x_trn</span><span class="p">,</span> <span class="n">y_trn</span><span class="p">)</span>
    <span class="n">valid_ds</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
    <span class="n">train_dl</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">valid_dl</span> <span class="o">=</span> <span class="n">TfmdDL</span><span class="p">(</span><span class="n">valid_ds</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DataBunch</span><span class="p">(</span><span class="n">train_dl</span><span class="p">,</span> <span class="n">valid_dl</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">RegModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Callback--">Callback -<a class="anchor-link" href="#Callback--">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>camel2snake</code>" class="doc_header"><code>camel2snake</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Callback--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>camel2snake</code>(<strong><code>name</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">camel2snake</span><span class="p">(</span><span class="s1">&#39;ClassAreCamel&#39;</span><span class="p">),</span> <span class="s1">&#39;class_are_camel&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="<code>class</code> <code>Callback</code>" class="doc_header"><code>class</code> <code>Callback</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Callback--" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Callback</code>()</p>
</blockquote>
<p>Basic class handling tweaks of the training loop by changing a <a href="/learner.html#Learner"><code>Learner</code></a> in various events</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The training loop is defined in <a href="/learner.html#Learner"><code>Learner</code></a> a bit below and consists in a minimal set of instructions: looping through the data we:</p>
<ul>
<li>compute the output of the model from the input</li>
<li>calculate a loss between this output and the desired target</li>
<li>compute the gradients of this loss with respect to all the model parameters</li>
<li>update the parameters accordingly</li>
<li>zero all the gradients</li>
</ul>
<p>Any tweak of this training loop is defined in a <a href="/learner.html#Callback"><code>Callback</code></a> to avoid over-complicating the code of the training loop, and to make it easy to mix and match different techniques (since they'll be defined in different callbacks). A callback can implement actions on the following events:</p>
<ul>
<li><code>begin_fit</code>: called before doing anything, ideal for initial setup.</li>
<li><code>begin_epoch</code>: called at the beginning of each epoch, useful for any behavior you need to reset at each epoch.</li>
<li><code>begin_batch</code>: called at the beginning of each batch, just after drawing said batch. It can be used to do any setup necessary for the batch (like hyper-parameter scheduling) or to change the input/target before it goes in the model (change of the input with techniques like mixup for instance).</li>
<li><code>after_pred</code>: called after computing the output of the model on the batch. It can be used to change that output before it's fed to the loss.</li>
<li><code>after_loss</code>: called after the loss has been computed, but before the backward pass. It can be used to add any penalty to the loss (AR or TAR in RNN training for instance).</li>
<li><code>after_backward</code>: called after the backward pass, but before the update of the parameters. It can be used to do any change to the gradients before said update (gradient clipping for instance).</li>
<li><code>after_step</code>: called after the step and before the gradients are zeroed.</li>
<li><code>after_batch</code>: called at the end of a batch, for any clean-up before the next one.</li>
<li><code>begin_validate</code>: called at the beginning of the validation phase of an epoch, useful for any setup needed specifically for validation.</li>
<li><code>after_epoch</code>: called at the end of an epoch, for any clean-up before the next one.</li>
<li><code>after_fit</code>: called at the end of training, for final clean-up.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Callback.__call__</code>" class="doc_header"><code>Callback.__call__</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Callback--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Callback.__call__</code>(<strong><code>event_name</code></strong>)</p>
</blockquote>
<p>Call <code>self.{event_name}</code> if it's defined</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tst_cb</span> <span class="o">=</span> <span class="n">Callback</span><span class="p">()</span>
<span class="n">tst_cb</span><span class="o">.</span><span class="n">call_me</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;maybe&quot;</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">tst_cb</span><span class="p">(</span><span class="s2">&quot;call_me&quot;</span><span class="p">),</span> <span class="s2">&quot;maybe&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Callback.__getattr__</code>" class="doc_header"><code>Callback.__getattr__</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Callback--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Callback.__getattr__</code>(<strong><code>k</code></strong>)</p>
</blockquote>
<p>Passthrough to get the attributes of <code>self.learn</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is a shortcut to avoid having to write <code>self.learn.bla</code> for any <code>bla</code> attribute we seek, and just write <code>self.bla</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TstLearner</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>

<span class="k">class</span> <span class="nc">TstCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>

<span class="n">learn</span><span class="p">,</span><span class="n">cb</span> <span class="o">=</span> <span class="n">TstLearner</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">TstCallback</span><span class="p">()</span>
<span class="n">cb</span><span class="o">.</span><span class="n">learn</span> <span class="o">=</span> <span class="n">learn</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">cb</span><span class="p">(</span><span class="s1">&#39;batch_begin&#39;</span><span class="p">),</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that it only works to get the value of the attribute, if you want to change it, you have to manually access it with <code>self.learn.bla</code>. In the example below, <code>self.a += 1</code> creates an <code>a</code> attribute of 2 in the callback instead of setting the <code>a</code> of the learner to 2:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TstCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">learn</span><span class="p">,</span><span class="n">cb</span> <span class="o">=</span> <span class="n">TstLearner</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">TstCallback</span><span class="p">()</span>
<span class="n">cb</span><span class="o">.</span><span class="n">learn</span> <span class="o">=</span> <span class="n">learn</span>
<span class="n">cb</span><span class="p">(</span><span class="s1">&#39;batch_begin&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cb</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cb</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A proper version needs to write <code>self.learn.a = self.a + 1</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TstCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">learn</span><span class="p">,</span><span class="n">cb</span> <span class="o">=</span> <span class="n">TstLearner</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">TstCallback</span><span class="p">()</span>
<span class="n">cb</span><span class="o">.</span><span class="n">learn</span> <span class="o">=</span> <span class="n">learn</span>
<span class="n">cb</span><span class="p">(</span><span class="s1">&#39;batch_begin&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cb</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<property object at 0x7ff2226ad9f8>" class="doc_header"><property object at 0x7ff2226ad9f8><a href="" class="source_link" style="float:right">[source]</a></h4><p>Name of the <a href="/learner.html#Callback"><code>Callback</code></a>, camel-cased and with Callback removed</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">TstCallback</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;tst&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ComplicatedNameCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span> <span class="k">pass</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">ComplicatedNameCallback</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;complicated_name&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="<code>class</code> <code>TrainEvalCallback</code>" class="doc_header"><code>class</code> <code>TrainEvalCallback</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#TrainEvalCallback--" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>TrainEvalCallback</code>() :: <a href="/learner.html#Callback"><code>Callback</code></a></p>
</blockquote>
<p><a href="/learner.html#Callback"><code>Callback</code></a> that tracks the number of iterations done and properly sets training/eval mode</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This <a href="/learner.html#Callback"><code>Callback</code></a> is automatically added in every <a href="/learner.html#Learner"><code>Learner</code></a> at initialization.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>TrainEvalCallback.begin_fit</code>" class="doc_header"><code>TrainEvalCallback.begin_fit</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#TrainEvalCallback--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TrainEvalCallback.begin_fit</code>()</p>
</blockquote>
<p>Set the iter and epoch counters to 0</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>TrainEvalCallback.begin_batch</code>" class="doc_header"><code>TrainEvalCallback.begin_batch</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#TrainEvalCallback--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TrainEvalCallback.begin_batch</code>()</p>
</blockquote>
<p>On the first batch, put the model on the right device</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>TrainEvalCallback.after_batch</code>" class="doc_header"><code>TrainEvalCallback.after_batch</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#TrainEvalCallback--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TrainEvalCallback.after_batch</code>()</p>
</blockquote>
<p>Update the iter counter (in training mode)</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>TrainEvalCallback.begin_epoch</code>" class="doc_header"><code>TrainEvalCallback.begin_epoch</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#TrainEvalCallback--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TrainEvalCallback.begin_epoch</code>()</p>
</blockquote>
<p>Set the model in training mode</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>TrainEvalCallback.begin_validate</code>" class="doc_header"><code>TrainEvalCallback.begin_validate</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#TrainEvalCallback--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TrainEvalCallback.begin_validate</code>()</p>
</blockquote>
<p>Set the model in validation mode</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Callbacks-control-flow">Callbacks control flow<a class="anchor-link" href="#Callbacks-control-flow">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It happens that we may want to skip some of the steps of the training loop: in gradient accumulation, we don't aways want to do the step/zeroing of the grads for instance. During an LR finder test, we don't want to do the validation phase of an epoch. Or if we're training with a strategy of early stopping, we want to be able to completely interrupt the training loop.</p>
<p>This is made possible by raising specific exceptions the training loop will look for (and properly catch).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="<code>class</code> <code>CancelBatchException</code>" class="doc_header"><code>class</code> <code>CancelBatchException</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Callbacks-control-flow" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>CancelBatchException</code>() :: <code>Exception</code></p>
</blockquote>
<p>Skip the rest of this batch and go to <code>after_batch</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="<code>class</code> <code>CancelTrainException</code>" class="doc_header"><code>class</code> <code>CancelTrainException</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Callbacks-control-flow" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>CancelTrainException</code>() :: <code>Exception</code></p>
</blockquote>
<p>Skip the rest of the training part of the epoch and go to <code>after_epoch</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="<code>class</code> <code>CancelValidException</code>" class="doc_header"><code>class</code> <code>CancelValidException</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Callbacks-control-flow" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>CancelValidException</code>() :: <code>Exception</code></p>
</blockquote>
<p>Skip the rest of the validation part of the epoch and go to <code>after_epoch</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="<code>class</code> <code>CancelEpochException</code>" class="doc_header"><code>class</code> <code>CancelEpochException</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Callbacks-control-flow" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>CancelEpochException</code>() :: <code>Exception</code></p>
</blockquote>
<p>Skip the rest of this epoch and go to <code>after_epoch</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="<code>class</code> <code>CancelFitException</code>" class="doc_header"><code>class</code> <code>CancelFitException</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Callbacks-control-flow" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>CancelFitException</code>() :: <code>Exception</code></p>
</blockquote>
<p>Interrupts training and go to <code>after_fit</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can detect one of those exceptions occurred and add code that executes right after with the following events:</p>
<ul>
<li><code>after_cancel_batch</code>: reached imediately after a <a href="/learner.html#CancelBatchException"><code>CancelBatchException</code></a> before proceeding to <code>after_batch</code></li>
<li><code>after_cancel_train</code>: reached imediately after a <a href="/learner.html#CancelTrainException"><code>CancelTrainException</code></a> before proceeding to <code>after_epoch</code></li>
<li><code>after_cancel_valid</code>: reached imediately after a <a href="/learner.html#CancelValidException"><code>CancelValidException</code></a> before proceeding to <code>after_epoch</code></li>
<li><code>after_cancel_epoch</code>: reached imediately after a <a href="/learner.html#CancelEpochException"><code>CancelEpochException</code></a> before proceeding to <code>after_epoch</code></li>
<li><code>after_cancel_fit</code>: reached imediately after a <a href="/learner.html#CancelFitException"><code>CancelFitException</code></a> before proceeding to <code>after_fit</code></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>trainable_params</code>" class="doc_header"><code>trainable_params</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Learner--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>trainable_params</code>(<strong><code>m</code></strong>)</p>
</blockquote>
<p>Return all trainable parameters of <code>m</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">trainable_params</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">])</span>
<span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">trainable_params</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>camel2snake</code>" class="doc_header"><code>camel2snake</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Callback--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>camel2snake</code>(<strong><code>name</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">camel2snake</span><span class="p">(</span><span class="s1">&#39;ClassAreCamel&#39;</span><span class="p">),</span> <span class="s1">&#39;class_are_camel&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="event" class="doc_header">event<a href="" class="source_link" style="float:right">[source]</a></h4><p>Object containing all possible events as attributes to get tab-completion and typo-proofing</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="<code>class</code> <code>Learner</code>" class="doc_header"><code>class</code> <code>Learner</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Learner--" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Learner</code>(<strong><code>model</code></strong>, <strong><code>data</code></strong>, <strong><code>loss_func</code></strong>, <strong><code>opt_func</code></strong>=<em><code>'SGD'</code></em>, <strong><code>lr</code></strong>=<em><code>0.01</code></em>, <strong><code>splitter</code></strong>=<em><code>'trainable_params'</code></em>, <strong><code>cbs</code></strong>=<em><code>None</code></em>, <strong><code>cb_funcs</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Group together a <code>model</code>, some <code>data</code> and a <code>loss_func</code> to handle training</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>opt_func</code> will be used to create an optimizer when <a href="/learner.html#Learner.fit"><code>Learner.fit</code></a> is called, with <code>lr</code> as a learning rate. <code>splitter</code> is a function taht takes <code>self.model</code> and returns a list of parameter groups (or just one parameter group if there are no different parameter groups). The default is <a href="/learner.html#trainable_params"><code>trainable_params</code></a>, which returns all trainable parameters of the model.</p>
<p><code>cbs</code> is one or a list of <a href="/learner.html#Callback"><code>Callback</code></a>s  to pass to the <a href="/learner.html#Learner"><code>Learner</code></a>, and <code>cb_funcs</code> is one or a list of functions returning a <a href="/learner.html#Callback"><code>Callback</code></a> that will be called at init. Each <a href="/learner.html#Callback"><code>Callback</code></a> is registered as an attribute of <a href="/learner.html#Learner"><code>Learner</code></a> (with camel case). At creation, a <a href="/learner.html#TrainEvalCallback"><code>TrainEvalCallback</code></a> is always associated to the <a href="/learner.html#Learner"><code>Learner</code></a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Test init with callbacks</span>
<span class="k">def</span> <span class="nf">synth_learner</span><span class="p">(</span><span class="n">n_trn</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_val</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Learner</span><span class="p">(</span><span class="n">RegModel</span><span class="p">(),</span> <span class="n">synth_data</span><span class="p">(</span><span class="n">n_trn</span><span class="o">=</span><span class="n">n_trn</span><span class="p">,</span><span class="n">n_val</span><span class="o">=</span><span class="n">n_val</span><span class="p">),</span> <span class="n">MSELossFlat</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="n">tst_learn</span> <span class="o">=</span> <span class="n">synth_learner</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tst_learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tst_learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TrainEvalCallback</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tst_learn</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;train_eval&#39;</span><span class="p">))</span>

<span class="n">tst_learn</span> <span class="o">=</span> <span class="n">synth_learner</span><span class="p">(</span><span class="n">cbs</span><span class="o">=</span><span class="n">TstCallback</span><span class="p">())</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tst_learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tst_learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TstCallback</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tst_learn</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;tst&#39;</span><span class="p">))</span>

<span class="n">tst_learn</span> <span class="o">=</span> <span class="n">synth_learner</span><span class="p">(</span><span class="n">cb_funcs</span><span class="o">=</span><span class="n">TstCallback</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tst_learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tst_learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TstCallback</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tst_learn</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;tst&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Training-loop">Training loop<a class="anchor-link" href="#Training-loop">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Learner.fit</code>" class="doc_header"><code>Learner.fit</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Learner--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.fit</code>(<strong><code>n_epoch</code></strong>, <strong><code>cbs</code></strong>=<em><code>None</code></em>, <strong><code>reset_opt</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Fit <code>self.model</code> for <code>epochs</code> using <code>cbs</code>. Optionally <code>reset_opt</code>.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Integration test: training a few epochs should make the model better</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">synth_learner</span><span class="p">(</span><span class="n">cb_funcs</span><span class="o">=</span><span class="n">TstCallback</span><span class="p">)</span>
<span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">init_loss</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">loss_func</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">xb</span><span class="p">),</span> <span class="n">yb</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">learn</span><span class="o">.</span><span class="n">loss</span> <span class="o">&lt;</span> <span class="n">init_loss</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Test of TrainEvalCallback</span>
<span class="k">class</span> <span class="nc">TestTrainEvalCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#Runs after TrainEvalCallback</span>
    <span class="k">def</span> <span class="nf">begin_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="n">test_eq</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pct_train</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">train_iter</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_pct_train</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">old_train_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pct_train</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">train_iter</span>
    
    <span class="k">def</span> <span class="nf">begin_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="n">test_eq</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">find_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xb</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">after_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">test_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pct_train</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_pct_train</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_iter</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="p">))</span>
            <span class="n">test_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_iter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_train_iter</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_pct_train</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">old_train_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pct_train</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">train_iter</span>
    
    <span class="k">def</span> <span class="nf">begin_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">training</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pct_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_pct_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pct_train</span>
    
    <span class="k">def</span> <span class="nf">begin_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">training</span>
        
<span class="n">learn</span> <span class="o">=</span> <span class="n">synth_learner</span><span class="p">(</span><span class="n">cb_funcs</span><span class="o">=</span><span class="n">TestTrainEvalCallback</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#Check order is properly taken into account</span>
<span class="n">learn</span><span class="o">.</span><span class="n">cbs</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Learner.one_batch</code>" class="doc_header"><code>Learner.one_batch</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Learner--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.one_batch</code>(<strong><code>xb</code></strong>, <strong><code>yb</code></strong>, <strong><code>i</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Train or evaluate <code>self.model</code> on batch <code>(xb,yb)</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is an internal method called by <a href="/learner.html#Learner.fit"><code>Learner.fit</code></a>. If passed, <code>i</code> is the index of this iteration in the epoch. In training method, this does a full training step on the batch (compute predictions, loss, gradients, update the model parameters and zero the gradients). In validation mode, it stops at the loss computation.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="<code>class</code> <code>VerboseCallback</code>" class="doc_header"><code>class</code> <code>VerboseCallback</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Training-loop" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>VerboseCallback</code>() :: <a href="/learner.html#Callback"><code>Callback</code></a></p>
</blockquote>
<p>Callback that prints the name of each event called</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TestOneBatch</span><span class="p">(</span><span class="n">VerboseCallback</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_xb</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">save_yb</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">xb</span><span class="p">,</span><span class="n">yb</span><span class="p">,</span><span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_pred</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">old_loss</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">begin_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">old_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span>    <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_xb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xb</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_yb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yb</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="p">,</span> <span class="s1">&#39;pred&#39;</span><span class="p">):</span> <span class="n">test_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_pred</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">after_pred</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xb</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_loss</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">after_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_pred</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_yb</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;grad&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">test_eq</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">]))</span>
    
    <span class="k">def</span> <span class="nf">after_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xb</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">yb</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_b</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">yb</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">test_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_a</span><span class="p">)</span>
        <span class="n">test_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_b</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_a</span><span class="p">)</span>
        <span class="n">test_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_b</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">after_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">test_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_a</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_a</span><span class="p">)</span>
        <span class="n">test_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_b</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_a</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">old_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">test_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_a</span><span class="p">)</span>
        <span class="n">test_close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad_b</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">after_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span> <span class="n">test_eq</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span> <span class="n">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">xb</span><span class="p">,</span><span class="n">yb</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">synth_learner</span><span class="p">(</span><span class="n">cbs</span><span class="o">=</span><span class="n">TestOneBatch</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="mi">42</span><span class="p">))</span>
<span class="c1">#Remove train/eval</span>
<span class="n">learn</span><span class="o">.</span><span class="n">cbs</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="c1">#Setup</span>
<span class="n">learn</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span><span class="n">learn</span><span class="o">.</span><span class="n">training</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span><span class="kc">True</span>
<span class="n">learn</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">learn</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="n">batch_events</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;begin_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;after_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;after_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;after_backward&#39;</span><span class="p">,</span> <span class="s1">&#39;after_step&#39;</span><span class="p">,</span> <span class="s1">&#39;after_batch&#39;</span><span class="p">]</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">one_batch</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="mi">42</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">batch_events</span><span class="p">))</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">one_batch</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="mi">42</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">batch_events</span><span class="p">))</span> <span class="c1">#Check it works for a second batch</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Learner.all_batches</code>" class="doc_header"><code>Learner.all_batches</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Learner--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.all_batches</code>()</p>
</blockquote>
<p>Train or evaluate <code>self.model</code> on all batches of <code>self.dl</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">synth_learner</span><span class="p">(</span><span class="n">n_trn</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">VerboseCallback</span><span class="p">())</span>
<span class="n">learn</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">learn</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
<span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()):</span> 
    <span class="n">learn</span><span class="o">.</span><span class="n">do_begin_fit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">learn</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span><span class="n">learn</span><span class="o">.</span><span class="n">dl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">learn</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">train_dl</span>
    <span class="n">learn</span><span class="p">(</span><span class="s1">&#39;begin_epoch&#39;</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">all_batches</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">batch_events</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">train_iter</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">valid_events</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;begin_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;after_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;after_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;after_batch&#39;</span><span class="p">]</span>
<span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()):</span> 
    <span class="n">learn</span><span class="o">.</span><span class="n">dl</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">valid_dl</span>
    <span class="n">learn</span><span class="p">(</span><span class="s1">&#39;begin_validate&#39;</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">all_batches</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_events</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">train_iter</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Learner.do_begin_fit</code>" class="doc_header"><code>Learner.do_begin_fit</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Learner--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.do_begin_fit</code>(<strong><code>n_epoch</code></strong>)</p>
</blockquote>
<p>Prepare evertyhing for training <code>epochs</code> epochs</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">synth_learner</span><span class="p">(</span><span class="n">n_trn</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">VerboseCallback</span><span class="p">())</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">do_begin_fit</span><span class="p">(</span><span class="mi">42</span><span class="p">),</span> <span class="s1">&#39;begin_fit&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">n_epoch</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Learner.do_epoch_train</code>" class="doc_header"><code>Learner.do_epoch_train</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Learner--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.do_epoch_train</code>(<strong><code>epoch</code></strong>)</p>
</blockquote>
<p>Execute the training part of the <code>epoch</code>-th epoch</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">learn</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">do_epoch_train</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;begin_epoch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_events</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Learner.do_epoch_validate</code>" class="doc_header"><code>Learner.do_epoch_validate</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Learner--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.do_epoch_validate</code>()</p>
</blockquote>
<p>Execute the validation part of an epoch</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_stdout</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">do_epoch_validate</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;begin_validate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">valid_events</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Callback-handling">Callback handling<a class="anchor-link" href="#Callback-handling">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Learner.__call__</code>" class="doc_header"><code>Learner.__call__</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Learner--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.__call__</code>(<strong><code>event_name</code></strong>)</p>
</blockquote>
<p>Call <code>event_name</code> for all callbacks</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Learner.add_cb</code>" class="doc_header"><code>Learner.add_cb</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Learner--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.add_cb</code>(<strong><code>cb</code></strong>)</p>
</blockquote>
<p>Add <code>cb</code> to the list of <a href="/learner.html#Callback"><code>Callback</code></a> and register <code>self</code> as their learner</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">synth_learner</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">add_cb</span><span class="p">(</span><span class="n">TestTrainEvalCallback</span><span class="p">())</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">TestTrainEvalCallback</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">train_eval</span><span class="o">.</span><span class="n">learn</span><span class="p">,</span> <span class="n">learn</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Learner.add_cbs</code>" class="doc_header"><code>Learner.add_cbs</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Learner--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.add_cbs</code>(<strong><code>cbs</code></strong>)</p>
</blockquote>
<p>Add <code>cbs</code> to the list of <a href="/learner.html#Callback"><code>Callback</code></a> and register <code>self</code> as their learner</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">add_cbs</span><span class="p">([</span><span class="n">TestTrainEvalCallback</span><span class="p">(),</span> <span class="n">TestTrainEvalCallback</span><span class="p">()])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Learner.remove_cb</code>" class="doc_header"><code>Learner.remove_cb</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Learner--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.remove_cb</code>(<strong><code>cb</code></strong>)</p>
</blockquote>
<p>Add <code>cb</code> from the list of <a href="/learner.html#Callback"><code>Callback</code></a> and deregister <code>self</code> as their learner</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cb</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">learn</span><span class="o">.</span><span class="n">remove_cb</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">cb</span><span class="o">.</span><span class="n">learn</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="k">assert</span> <span class="n">learn</span><span class="o">.</span><span class="n">test_train_eval</span> <span class="ow">is</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="<code>Learner.remove_cbs</code>" class="doc_header"><code>Learner.remove_cbs</code><a href="https://nbviewer.jupyter.org/github/fastai/fastai_docs/blob/master/dev/12_learner.ipynb#Learner--" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Learner.remove_cbs</code>(<strong><code>cbs</code></strong>)</p>
</blockquote>
<p>Remove <code>cbs</code> from the list of <a href="/learner.html#Callback"><code>Callback</code></a> and deregister <code>self</code> as their learner</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cb</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">learn</span><span class="o">.</span><span class="n">remove_cbs</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">cbs</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When writing a callback, the following attributes of <a href="/learner.html#Learner"><code>Learner</code></a> are available:</p>
<ul>
<li><code>model</code>: the model used for training/validation</li>
<li><code>data</code>: the underlying <a href="/data.core.html#DataBunch"><code>DataBunch</code></a></li>
<li><code>loss_func</code>: the loss function used</li>
<li><code>opt</code>: the optimizer used to udpate the model parameters</li>
<li><code>opt_func</code>: the function used to create the optimizer</li>
<li><code>cbs</code>: the list containing all <a href="/learner.html#Callback"><code>Callback</code></a>s</li>
<li><code>dl</code>: current <a href="https://pytorch.org/docs/stable/data.html#torch.utils.data.DataLoader"><code>DataLoader</code></a> used for iteration</li>
<li><code>xb</code>: last input drawn from <code>self.dl</code> (potentially modified by callbacks)</li>
<li><code>yb</code>: last target drawn from <code>self.dl</code> (potentially modified by callbacks)</li>
<li><code>pred</code>: last predictions from <code>self.model</code> (potentially modified by callbacks)</li>
<li><code>loss</code>: last computed loss (potentially modified by callbacks)</li>
<li><code>n_epoch</code>: the number of epochs in this training</li>
<li><code>n_iter</code>: the number of iterations in the current <code>self.dl</code></li>
<li><code>epoch</code>: the current epoch index (from 0 to <code>n_epoch-1</code>)</li>
<li><code>iter</code>: the current iteration index in <code>self.dl</code> (from 0 to <code>n_iter-1</code>)</li>
</ul>
<p>The following attributes are added by <a href="/learner.html#TrainEvalCallback"><code>TrainEvalCallback</code></a> and should be available unless you went out of your way to remove that callback:</p>
<ul>
<li><code>train_iter</code>: the number of training iterations done since the beginning of this training</li>
<li><code>pct_train</code>: from 0. to 1., the percentage of training iterations completed</li>
<li><code>training</code>:  flag to indicate if we're in training mode or not</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Control-flow-testing">Control flow testing<a class="anchor-link" href="#Control-flow-testing">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cycle_events</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;begin_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;begin_epoch&#39;</span><span class="p">,</span> <span class="s1">&#39;begin_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;after_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;after_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;after_backward&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;after_step&#39;</span><span class="p">,</span> <span class="s1">&#39;after_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;begin_validate&#39;</span><span class="p">,</span> <span class="s1">&#39;begin_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;after_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;after_loss&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;after_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;after_epoch&#39;</span><span class="p">,</span> <span class="s1">&#39;after_fit&#39;</span><span class="p">]</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">synth_learner</span><span class="p">(</span><span class="n">n_trn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_val</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">VerboseCallback</span><span class="p">()),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cycle_events</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TestCancelCallback</span><span class="p">(</span><span class="n">VerboseCallback</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cancel_at</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">begin_batch</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">CancelBatchException</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_interrupt</span><span class="p">():</span> 
            <span class="k">if</span> <span class="n">train</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">train</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span> <span class="k">raise</span> <span class="n">exception</span><span class="p">()</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cancel_at</span><span class="p">,</span> <span class="n">_interrupt</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#test cancel batch</span>
<span class="n">batch_events</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;begin_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;after_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;after_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;after_backward&#39;</span><span class="p">,</span> <span class="s1">&#39;after_step&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_events</span><span class="p">):</span>
    <span class="n">be</span> <span class="o">=</span> <span class="n">batch_events</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;after_cancel_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;after_batch&#39;</span><span class="p">]</span>
    <span class="n">bev</span> <span class="o">=</span> <span class="n">be</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span><span class="mi">3</span> <span class="k">else</span> <span class="n">batch_events</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;after_batch&#39;</span><span class="p">]</span>
    <span class="n">cycle</span> <span class="o">=</span> <span class="n">cycle_events</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">be</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;begin_validate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bev</span> <span class="o">+</span> <span class="n">cycle_events</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">TestCancelCallback</span><span class="p">(</span><span class="n">cancel_at</span><span class="o">=</span><span class="n">e</span><span class="p">)),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cycle</span><span class="p">))</span>

<span class="c1">#CancelBatchException not caught if thrown in any other event</span>
<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cycle_events</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch_events</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()):</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">TestCancelCallback</span><span class="p">(</span><span class="n">cancel_at</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">cb</span><span class="p">))</span>
            <span class="n">learn</span><span class="o">.</span><span class="n">remove_cb</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="c1">#Have to remove it manually</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#test cancel train</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;begin_epoch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_events</span><span class="p">):</span>
    <span class="n">be</span> <span class="o">=</span> <span class="n">batch_events</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="s1">&#39;after_batch&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span><span class="mi">1</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;after_cancel_train&#39;</span><span class="p">]</span>
    <span class="n">bev</span> <span class="o">=</span> <span class="n">batch_events</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;after_batch&#39;</span><span class="p">]</span>
    <span class="n">cycle</span> <span class="o">=</span> <span class="n">cycle_events</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">be</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;begin_validate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bev</span> <span class="o">+</span> <span class="n">cycle_events</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">TestCancelCallback</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">CancelTrainException</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cycle</span><span class="p">))</span>

<span class="c1">#CancelTrainException not caught if thrown in any other event</span>
<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cycle_events</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;begin_epoch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_events</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()):</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">TestCancelCallback</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">CancelTrainException</span><span class="p">)</span>
            <span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">cb</span><span class="p">))</span>
            <span class="n">learn</span><span class="o">.</span><span class="n">remove_cb</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="c1">#Have to remove it manually  </span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#test cancel valid</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;begin_validate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_events</span><span class="p">[:</span><span class="mi">3</span><span class="p">]):</span>
    <span class="n">be</span> <span class="o">=</span> <span class="n">batch_events</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;after_batch&#39;</span><span class="p">]</span>
    <span class="n">bev</span> <span class="o">=</span> <span class="n">batch_events</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="s1">&#39;after_batch&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span><span class="mi">1</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;after_cancel_validate&#39;</span><span class="p">]</span>
    <span class="n">cycle</span> <span class="o">=</span> <span class="n">cycle_events</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">be</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;begin_validate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bev</span> <span class="o">+</span> <span class="n">cycle_events</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">TestCancelCallback</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">CancelValidException</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cycle</span><span class="p">))</span>
    
<span class="c1">#CancelValidException not caught if thrown in any other event</span>
<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cycle_events</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;begin_validate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_events</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
        <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()):</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">TestCancelCallback</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">CancelValidException</span><span class="p">)</span>
            <span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">cb</span><span class="p">))</span>
            <span class="n">learn</span><span class="o">.</span><span class="n">remove_cb</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="c1">#Have to remove it manually  </span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#test cancel epoch</span>
<span class="c1">#In train</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;begin_epoch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_events</span><span class="p">):</span>
    <span class="n">be</span> <span class="o">=</span> <span class="n">batch_events</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="s1">&#39;after_batch&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span><span class="mi">1</span> <span class="k">else</span> <span class="p">[])</span> 
    <span class="n">cycle</span> <span class="o">=</span> <span class="n">cycle_events</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">be</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;after_cancel_epoch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cycle_events</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">TestCancelCallback</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">CancelEpochException</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cycle</span><span class="p">))</span>
    
<span class="c1">#In valid</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;begin_validate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_events</span><span class="p">[:</span><span class="mi">3</span><span class="p">]):</span>
    <span class="n">be</span> <span class="o">=</span> <span class="n">batch_events</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;after_batch&#39;</span><span class="p">]</span>
    <span class="n">bev</span> <span class="o">=</span> <span class="n">batch_events</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="s1">&#39;after_batch&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span><span class="mi">1</span> <span class="k">else</span> <span class="p">[])</span>
    <span class="n">cycle</span> <span class="o">=</span> <span class="n">cycle_events</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">be</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;begin_validate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bev</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;after_cancel_epoch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cycle_events</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">TestCancelCallback</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">CancelEpochException</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cycle</span><span class="p">))</span>
    
<span class="c1">#CancelEpochException not caught if thrown in any other event</span>
<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;begin_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;after_epoch&#39;</span><span class="p">,</span> <span class="s1">&#39;after_fit&#39;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;begin_validate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_events</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
        <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()):</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">TestCancelCallback</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">CancelEpochException</span><span class="p">)</span>
            <span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">cb</span><span class="p">))</span>
            <span class="n">learn</span><span class="o">.</span><span class="n">remove_cb</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="c1">#Have to remove it manually  </span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#test cancel fit</span>
<span class="c1">#In begin fit</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">TestCancelCallback</span><span class="p">(</span><span class="s1">&#39;begin_fit&#39;</span><span class="p">,</span> <span class="n">CancelFitException</span><span class="p">)),</span> 
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;begin_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;after_cancel_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;after_fit&#39;</span><span class="p">]))</span>

<span class="c1">#In train</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;begin_epoch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_events</span><span class="p">):</span>
    <span class="n">be</span> <span class="o">=</span> <span class="n">batch_events</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="s1">&#39;after_batch&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span><span class="mi">1</span> <span class="k">else</span> <span class="p">[])</span> 
    <span class="n">cycle</span> <span class="o">=</span> <span class="n">cycle_events</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">be</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;after_epoch&#39;</span><span class="p">,</span> <span class="s1">&#39;after_cancel_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;after_fit&#39;</span><span class="p">]</span>
    <span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">TestCancelCallback</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">CancelFitException</span><span class="p">,</span> <span class="kc">True</span><span class="p">)),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cycle</span><span class="p">))</span>
    
<span class="c1">#In valid</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;begin_validate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_events</span><span class="p">[:</span><span class="mi">3</span><span class="p">]):</span>
    <span class="n">be</span> <span class="o">=</span> <span class="n">batch_events</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;after_batch&#39;</span><span class="p">]</span>
    <span class="n">bev</span> <span class="o">=</span> <span class="n">batch_events</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="s1">&#39;after_batch&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span><span class="mi">1</span> <span class="k">else</span> <span class="p">[])</span>
    <span class="n">cycle</span> <span class="o">=</span> <span class="n">cycle_events</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">be</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;begin_validate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">bev</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;after_epoch&#39;</span><span class="p">,</span> <span class="s1">&#39;after_cancel_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;after_fit&#39;</span><span class="p">]</span>
    <span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">TestCancelCallback</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">CancelFitException</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cycle</span><span class="p">))</span>
    
<span class="c1">#CancelEpochException not caught if thrown in any other event</span>
<span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()):</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">TestCancelCallback</span><span class="p">(</span><span class="s1">&#39;after_fit&#39;</span><span class="p">,</span> <span class="n">CancelEpochException</span><span class="p">)</span>
    <span class="n">test_fail</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">cb</span><span class="p">))</span>
    <span class="n">learn</span><span class="o">.</span><span class="n">remove_cb</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="c1">#Have to remove it manually  </span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>
 

